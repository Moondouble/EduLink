<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>게시판 상세 페이지</title>
<style>
html {
	font-family: "Noto Sans KR", sans-serif;
}

body, ul, li, h1, h2, h3, h4, h5, h6 {
	margin: 0;
	padding: 0;
	list-style: none;
}

.con {
	margin: 0 auto;
	max-width: 950px;
}

.article-detail {
	border: 2px solid lightgray;
	padding: 20px;
	box-sizing: border-box;
}

.article-detail>table {
	width: 100%;
	border-collapse: collapse;
	margin-top: 10px;
}

.article-detail>table th, .article-detail>table td {
	border: 1px solid lightgray;
	padding: 10px;
	text-align: left;
}

.article-detail>table tr.article-title>td {
	font-weight: bold;
	font-size: 1.2rem;
	text-align: center;
}

.article-detail>.article-writer span {
	font-size: 1rem;
}

.text-align-center {
	text-align: center;
}

.text-align-center a {
	margin: 0 10px;
	text-decoration: none;
	color: blue;
}

.text-align-center a:hover {
	text-decoration: underline;
}
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
$(document).ready(function() {
    // 댓글 수정 버튼 클릭 시
    $(document).on('click', 'a:contains("수정하기")', function(e) {
        e.preventDefault();
        const replyNum = $(this).closest('tr').find('td').eq(1).text().trim(); // 댓글 번호
        const replyElement = $(this).closest('tr').find('td').eq(2); // 댓글 내용이 있는 td
        const currentContent = replyElement.text().trim();

        // 수정 창 삽입
        const editBoxHtml = `
            <div class="edit-box">
                <textarea rows="4">${currentContent}</textarea>
                <button class="save-reply-btn" data-num="${replyNum}">저장</button>
                <button class="cancel-reply-btn" data-num="${replyNum}" data-content="${currentContent}">취소</button>
            </div>
        `;
        replyElement.html(editBoxHtml); // 댓글 내용 수정창으로 교체
    });

    // 댓글 저장 버튼 클릭 시
    $(document).on('click', '.save-reply-btn', function(e) {
        e.preventDefault();
        const replyNum = $(this).data('num'); // 댓글 번호
        const replyElement = $(this).closest('tr').find('td').eq(2); // 댓글 내용이 있는 td
        const updatedContent = replyElement.find('textarea').val(); // 수정된 내용

        // AJAX 요청으로 서버에 수정된 댓글 전송
        $.ajax({
            url: '/replyUpdate', // 서버의 댓글 수정 API 엔드포인트
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                replyNum: replyNum,  // 수정된 댓글 번호
                replyContents: updatedContent // 수정된 댓글 내용
            }),
            success: function(response) {
                alert('댓글이 성공적으로 수정되었습니다.');
                replyElement.html(updatedContent); // UI에 반영
            },
            error: function(xhr, status, error) {
                alert('댓글 수정에 실패했습니다.');
                console.error(error);
            }
        });
    });

    // 댓글 수정 취소 버튼 클릭 시
    $(document).on('click', '.cancel-reply-btn', function(e) {
        e.preventDefault();
        const replyNum = $(this).data('num');
        const originalContent = $(this).data('content');
        const replyElement = $(this).closest('tr').find('td').eq(2);
        replyElement.html(originalContent); // 원래 내용으로 복구
    });
});
</script>

</head>
<body>
	<h1 class="con">게시글 상세보기</h1>
	<section class="article-detail con">
		<table>
			<tbody>
				<tr class="article-title">
					<th>제목</th>
					<td colspan="3">[[${boardCommand.boardName}]]</td>
				</tr>
				<tr>
					<th>강의번호</th>
					<td>[[${boardCommand.classNum}]]</td>
					<th>작성자</th>
					<td><span th:if="${boardCommand.studentNum != null}">[[${boardCommand.studentNum}]]
							(학생)</span> <span th:if="${boardCommand.teacherNum != null}">[[${boardCommand.teacherNum}]]
							(교육자)</span></td>
				</tr>
				<tr>
					<td colspan="4">[[${boardCommand.boardContents}]]</td>
				</tr>
			</tbody>
		</table>
		<table>
			<form action="replyWrite" method="post" th:object="${replyCommand}">
				<input type="hidden" name="boardNum"
					th:value="${boardCommand.boardNum}">
				<tbody>
					<tr class="article-title">
						<th colspan="4">답글</th>
					</tr>
					<tr th:each="dto : ${list}">
						<td>[[${dto.teacherNum}]]<br />
						<span>[[${dto.replyDate}]]</span></td>
						<td colspan="3">[[${dto.replyContents}]]<br /> <span
							th:if="${session.auth.userNum} == ${dto.teacherNum}">
								<a href="#" onclick="">수정하기</a>

								<a
								th:href="|replyDelete?replyNum=${dto.replyNum}&boardNum=${dto.boardNum}|">삭제하기</a>
						</span></td>
					</tr>
					<div th:if="${session.auth.grade == 'teacher'}">
						<tr>
							<td>작성자</td>
							<td colspan="3"><input type="text" name="TeacherNum"
								th:value="${session.auth.userNum}" readonly="readonly"></td>
						</tr>
						<tr>
							<td>댓글</td>
							<td colspan="3"><textarea rows="4" cols="100"
									name="replyContents" title="댓글을 작성해주세요"></textarea></td>
						</tr>
						<tr>
							<td colspan="4"><input type="submit" value="답글달기"
								style="align-items: right;"></td>
						</tr>
					</div>
				</tbody>
			</form>
		</table>
		<div class="text-align-center">
			<a th:href="|boardUpdate?boardNum=${boardCommand.boardNum}|">수정</a> |
			<a
				th:href="|boardDelete?boardNum=${boardCommand.boardNum}&classNum=${boardCommand.classNum}|">삭제</a>
			| <a th:href="|boardList?classNum=${boardCommand.classNum}|">글목록</a>
		</div>
	</section>
</body>
</html>
